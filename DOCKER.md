# üê≥ Guia Docker - FatigueSensor

Este guia explica como executar o FatigueSensor utilizando Docker e Docker Compose de forma simples e eficiente.

## üìã Pr√©-requisitos

- **Docker**: Vers√£o 20.10 ou superior
- **Docker Compose**: Vers√£o 2.0 ou superior  
- **Webcam**: C√¢mera USB ou integrada
- **Sistema de √Åudio**: Para alertas sonoros
- **Linux/WSL2**: Sistema compat√≠vel com X11 (recomendado)

### Verifica√ß√£o dos Pr√©-requisitos

```bash
# Verificar vers√µes instaladas
docker --version
docker-compose --version

# Verificar dispositivos de c√¢mera
ls /dev/video*

# Verificar dispositivos de √°udio
ls /dev/snd/

# Verificar sistema X11 (Linux)
echo $DISPLAY
```

## üöÄ In√≠cio R√°pido

### 1. Setup Autom√°tico (Recomendado)

Execute o script de configura√ß√£o autom√°tica que faz todo o trabalho pesado:

```bash
# Clone o reposit√≥rio
git clone https://github.com/seu-usuario/fatigue-sensor.git
cd fatigue-sensor

# Torne o script execut√°vel e execute
chmod +x install.sh
./install.sh
```

**O que o script faz automaticamente:**
- ‚úÖ Verifica pr√©-requisitos (Docker, c√¢mera, √°udio)
- ‚úÖ Configura permiss√µes do X11 para interface gr√°fica
- ‚úÖ Baixa o modelo de marcos faciais (shape_predictor_68_face_landmarks.dat)
- ‚úÖ Cria arquivo de configura√ß√£o (.env)
- ‚úÖ Mostra todos os comandos dispon√≠veis

### 2. Execu√ß√£o Manual

Se preferir configurar passo a passo:

```bash
# Permitir acesso ao X11 (Linux/WSL)
xhost +local:docker

# Criar arquivo .env
echo "DISPLAY=$DISPLAY" > .env

# Construir e executar
docker-compose up --build
```

## üõ†Ô∏è Comandos Principais

### Constru√ß√£o e Execu√ß√£o

```bash
# Construir e executar o servi√ßo principal
docker-compose up --build

# Executar em background (daemon)
docker-compose up -d

# For√ßar reconstru√ß√£o completa
docker-compose build --no-cache
docker-compose up

# Executar apenas uma vez (sem restart autom√°tico)
docker-compose run --rm fatigue-sensor
```

### Controle de Servi√ßos

```bash
# Parar todos os servi√ßos
docker-compose down

# Parar e remover volumes persistentes
docker-compose down -v

# Reiniciar servi√ßos espec√≠ficos
docker-compose restart fatigue-sensor

# Parar apenas um servi√ßo
docker-compose stop fatigue-sensor
```

### Logs e Monitoramento

```bash
# Ver logs em tempo real
docker-compose logs -f

# Ver logs de servi√ßo espec√≠fico
docker-compose logs -f fatigue-sensor

# Ver √∫ltimas 50 linhas dos logs
docker-compose logs --tail=50

# Logs sem timestamps
docker-compose logs --no-log-prefix
```

## ‚öôÔ∏è Configura√ß√µes Avan√ßadas

### Par√¢metros Personalizados

```bash
# Executar com limiares customizados
docker-compose run --rm fatigue-sensor python3 main.py --ear-threshold 0.22 --mar-threshold 0.70

# Executar exemplos de uso pr√©-configurados
docker-compose run --rm fatigue-sensor python3 exemplos_uso.py

# Executar exemplo espec√≠fico (modo rigoroso)
docker-compose run --rm fatigue-sensor python3 -c "
import exemplos_uso
exemplos_uso.exemplo_deteccao_rigorosa()
"
```

### Perfis de Detec√ß√£o Dispon√≠veis

O sistema inclui diferentes perfis otimizados para cen√°rios espec√≠ficos:

```bash
# Modo Padr√£o - Uso geral
docker-compose run --rm fatigue-sensor python3 main.py

# Modo Sens√≠vel - Para motoristas experientes
docker-compose run --rm fatigue-sensor python3 main.py --ear-threshold 0.22 --mar-threshold 0.60

# Modo Rigoroso - Para situa√ß√µes de alto risco
docker-compose run --rm fatigue-sensor python3 main.py --ear-threshold 0.28 --mar-threshold 0.55

# Modo Permissivo - Para condi√ß√µes de pouca luz
docker-compose run --rm fatigue-sensor python3 main.py --ear-threshold 0.20 --mar-threshold 0.70
```

### Modo Desenvolvimento

```bash
# Ativar container de desenvolvimento com shell interativo
docker-compose --profile dev up fatigue-sensor-dev

# Executar bash no container em execu√ß√£o
docker-compose exec fatigue-sensor bash

# Montar c√≥digo local para desenvolvimento (modo dev j√° configurado)
# O perfil 'dev' mapeia automaticamente o c√≥digo local para /app
```

### M√∫ltiplas C√¢meras

Para sistemas com m√∫ltiplas c√¢meras, edite o `docker-compose.yml`:

```yaml
devices:
  - /dev/video0:/dev/video0    # C√¢mera principal
  - /dev/video1:/dev/video1    # C√¢mera secund√°ria
  - /dev/video2:/dev/video2    # C√¢mera adicional
  # Adicione quantas c√¢meras precisar
```

### Configura√ß√µes de √Åudio Avan√ßadas

```bash
# Verificar configura√ß√£o atual do PulseAudio
docker-compose exec fatigue-sensor pulseaudio --check

# Testar √°udio no container
docker-compose exec fatigue-sensor pactl list short sinks

# Para sistemas com PipeWire (alternativa ao PulseAudio)
# Editar docker-compose.yml para mapear sockets do PipeWire
```

## üîß Resolu√ß√£o de Problemas

### Problema: "N√£o foi poss√≠vel acessar a c√¢mera"

**Diagn√≥stico:**
```bash
# Verificar se c√¢mera est√° dispon√≠vel no host
ls -la /dev/video*
v4l2-ctl --list-devices  # Se dispon√≠vel

# Verificar permiss√µes
groups $USER | grep -E "(video|audio)"
```

**Solu√ß√µes:**
```bash
# Adicionar usu√°rio aos grupos necess√°rios
sudo usermod -a -G video,audio $USER

# Dar permiss√µes tempor√°rias aos dispositivos
sudo chmod 666 /dev/video0
sudo chmod -R 666 /dev/snd/

# Reiniciar sess√£o para aplicar mudan√ßas de grupo
# ou executar temporariamente com sudo
sudo docker-compose up
```

### Problema: "Display n√£o encontrado" / "Interface n√£o aparece"

**Para Linux/WSL2:**
```bash
# Verificar vari√°vel DISPLAY
echo $DISPLAY

# Reconfigurar X11
xhost +local:docker

# Para WSL2 especificamente
export DISPLAY=:0
# ou para Windows 11 com WSLg
export DISPLAY=:0.0
```

**Para Windows com WSL2:**
```bash
# Instalar servidor X11 (escolha um):
# VcXsrv, Xming, ou usar WSLg nativo (Windows 11)

# Configurar DISPLAY para servidor X externo
export DISPLAY=host.docker.internal:0.0
```

**Para macOS:**
```bash
# Instalar XQuartz
brew install --cask xquartz

# Configurar XQuartz
xhost +localhost
export DISPLAY=host.docker.internal:0
```

### Problema: "Som n√£o funciona"

**Diagn√≥stico:**
```bash
# Verificar status do PulseAudio
pulseaudio --check
systemctl --user status pulseaudio

# Listar dispositivos de √°udio
pactl list short sinks
```

**Solu√ß√µes:**
```bash
# Reiniciar PulseAudio
pulseaudio --kill
pulseaudio --start

# Para sistemas sem PulseAudio (usar ALSA)
# Modificar docker-compose.yml para mapear dispositivos ALSA

# Verificar se container tem acesso ao √°udio
docker-compose exec fatigue-sensor ls -la /dev/snd/
```

### Problema: "Permission denied" em dispositivos

**Solu√ß√£o tempor√°ria:**
```bash
sudo chmod 666 /dev/video0
sudo chmod -R 666 /dev/snd/
```

**Solu√ß√£o permanente (criar regras udev):**
```bash
# Criar arquivo de regras
sudo nano /etc/udev/rules.d/99-fatigue-sensor.rules

# Adicionar conte√∫do:
SUBSYSTEM=="video4linux", GROUP="video", MODE="0666"
SUBSYSTEM=="sound", GROUP="audio", MODE="0666"
KERNEL=="controlC[0-9]*", GROUP="audio", MODE="0666"

# Recarregar regras
sudo udevadm control --reload-rules
sudo udevadm trigger
```

### Problema: "Modelo de marcos faciais n√£o encontrado"

**Solu√ß√£o autom√°tica:**
```bash
# O install.sh baixa automaticamente, mas se precisar fazer manualmente:
wget -O shape_predictor_68_face_landmarks.dat \
  "https://huggingface.co/spaces/asdasdasdasd/Face-forgery-detection/resolve/ccfc24642e0210d4d885bc7b3dbc9a68ed948ad6/shape_predictor_68_face_landmarks.dat"

# Verificar se arquivo foi baixado corretamente (deve ter ~68MB)
ls -lh shape_predictor_68_face_landmarks.dat
```

## üêõ Debug e Desenvolvimento

### Executar com Debug Avan√ßado

```bash
# Habilitar logs verbose do Python
docker-compose run --rm fatigue-sensor python3 -u main.py

# Executar com debugger interativo
docker-compose run --rm fatigue-sensor python3 -m pdb main.py

# Executar com logs de OpenCV detalhados
docker-compose run --rm -e OPENCV_LOG_LEVEL=DEBUG fatigue-sensor python3 main.py
```

### Inspe√ß√£o do Container

```bash
# Listar todos os containers
docker ps -a

# Executar comandos no container ativo
docker exec -it fatigue-sensor bash
docker exec -it fatigue-sensor python3 --version

# Verificar logs detalhados do container
docker logs --details fatigue-sensor

# Inspecionar configura√ß√£o do container
docker inspect fatigue-sensor
```

### Testes de Funcionalidade

```bash
# Testar detec√ß√£o de c√¢mera
docker-compose run --rm fatigue-sensor python3 -c "
import cv2
cap = cv2.VideoCapture(0)
print('C√¢mera dispon√≠vel:', cap.isOpened())
cap.release()
"

# Testar carregamento do modelo dlib
docker-compose run --rm fatigue-sensor python3 -c "
import dlib
import os
if os.path.exists('shape_predictor_68_face_landmarks.dat'):
    predictor = dlib.shape_predictor('shape_predictor_68_face_landmarks.dat')
    print('Modelo carregado com sucesso')
else:
    print('Modelo n√£o encontrado')
"

# Executar exemplos de uso para testes
docker-compose run --rm fatigue-sensor python3 exemplos_uso.py
```

### Limpeza do Sistema

```bash
# Remover containers parados
docker container prune -f

# Remover imagens n√£o utilizadas
docker image prune -f

# Remover volumes √≥rf√£os
docker volume prune -f

# Limpeza completa (CUIDADO! Remove tudo n√£o usado)
docker system prune -a -f

# Limpeza espec√≠fica do projeto
docker-compose down -v --rmi all
```

## üìä Monitoramento e Performance

### Recursos do Container

```bash
# Estat√≠sticas em tempo real
docker stats fatigue-sensor

# Uso detalhado de recursos
docker-compose top

# Verificar limites de recurso
docker inspect fatigue-sensor | grep -A 10 "Memory"
```

### Verifica√ß√£o de Sa√∫de do Sistema

```bash
# Status dos servi√ßos
docker-compose ps

# Verificar processos em execu√ß√£o no container
docker-compose exec fatigue-sensor ps aux

# Teste de conectividade com dispositivos
docker-compose exec fatigue-sensor ls -la /dev/video* /dev/snd/

# Verificar vari√°veis de ambiente
docker-compose exec fatigue-sensor env | grep -E "(DISPLAY|PULSE)"
```

### Otimiza√ß√£o de Performance

```bash
# Executar com diferentes resolu√ß√µes (modificar main.py se necess√°rio)
# Ou usar par√¢metros para reduzir processamento

# Monitorar FPS em tempo real
docker-compose logs -f | grep "FPS"

# Para GPUs NVIDIA (se dispon√≠vel)
# Instalar nvidia-docker2 e modificar docker-compose.yml:
#   runtime: nvidia
#   environment:
#     - NVIDIA_VISIBLE_DEVICES=all
```

## üîí Seguran√ßa e Boas Pr√°ticas

### Usu√°rio N√£o-Root

O container executa com usu√°rio n√£o-privilegiado (`appuser`) por seguran√ßa:

```bash
# Verificar usu√°rio atual no container
docker-compose exec fatigue-sensor whoami
docker-compose exec fatigue-sensor id

# Verificar propriet√°rio dos arquivos
docker-compose exec fatigue-sensor ls -la /app
```

### Limita√ß√£o de Recursos

Edite `docker-compose.yml` para limitar recursos:

```yaml
services:
  fatigue-sensor:
    # ... outras configura√ß√µes
    deploy:
      resources:
        limits:
          cpus: '2.0'          # M√°ximo 2 CPUs
          memory: 2G           # M√°ximo 2GB RAM
        reservations:
          cpus: '0.5'          # Reserva m√≠nima de 0.5 CPU
          memory: 512M         # Reserva m√≠nima de 512MB
    
    # Alternativamente, usando sintaxe v2 do Compose:
    mem_limit: 2g
    memswap_limit: 2g
    cpus: 2.0
```

### Isolamento de Rede

```yaml
# Para maior seguran√ßa, use rede personalizada
networks:
  fatigue-sensor-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

services:
  fatigue-sensor:
    networks:
      - fatigue-sensor-net
```

## üìÅ Estrutura de Arquivos Docker

```txt
fatigue-sensor/
‚îú‚îÄ‚îÄ üìÅ Arquivos Docker
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile                    # Defini√ß√£o da imagem principal
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml            # Orquestra√ß√£o dos servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ .dockerignore                 # Arquivos exclu√≠dos do build
‚îÇ   ‚îî‚îÄ‚îÄ install.sh                    # Script de instala√ß√£o autom√°tica
‚îú‚îÄ‚îÄ üìÅ C√≥digo Principal
‚îÇ   ‚îú‚îÄ‚îÄ main.py                       # Aplica√ß√£o principal
‚îÇ   ‚îú‚îÄ‚îÄ exemplos_uso.py               # Exemplos e perfis de detec√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt              # Depend√™ncias Python
‚îú‚îÄ‚îÄ üìÅ Modelos e Dados
‚îÇ   ‚îî‚îÄ‚îÄ shape_predictor_68_face_landmarks.dat  # Modelo de marcos faciais
‚îú‚îÄ‚îÄ üìÅ Configura√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ .env                          # Vari√°veis de ambiente (criado automaticamente)
‚îÇ   ‚îî‚îÄ‚îÄ .gitignore                    # Arquivos ignorados pelo Git
‚îî‚îÄ‚îÄ üìÅ Documenta√ß√£o
    ‚îú‚îÄ‚îÄ README.md                     # Documenta√ß√£o principal
    ‚îú‚îÄ‚îÄ DOCKER.md                     # Este guia Docker
    ‚îî‚îÄ‚îÄ LICENSE                       # Licen√ßa do projeto
```

## üéØ Casos de Uso Espec√≠ficos

### Ambiente de Produ√ß√£o

```bash
# Para uso em produ√ß√£o, configure:
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# docker-compose.prod.yml example:
# version: '3.8'
# services:
#   fatigue-sensor:
#     restart: always
#     logging:
#       driver: "json-file"
#       options:
#         max-size: "10m"
#         max-file: "3"
```

### Desenvolvimento e Testes

```bash
# Usar perfil de desenvolvimento
docker-compose --profile dev up fatigue-sensor-dev

# Executar testes unit√°rios (se implementados)
docker-compose run --rm fatigue-sensor python3 -m pytest tests/

# Verificar diferentes cen√°rios
docker-compose run --rm fatigue-sensor python3 exemplos_uso.py
```

### Integra√ß√£o Cont√≠nua

```yaml
# Exemplo para .github/workflows/docker.yml
name: Docker Build and Test
on: [push, pull_request]
jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker image
        run: docker build -t fatigue-sensor .
      - name: Test container
        run: |
          docker run --rm fatigue-sensor python3 -c "import main; print('Import successful')"
```

## ü§ù Contribui√ß√µes

Para contribuir com melhorias no setup Docker:

1. **Fork o projeto**
```bash
git clone https://github.com/seu-usuario/fatigue-sensor.git
cd fatigue-sensor
```

2. **Crie uma branch para sua feature**
```bash
git checkout -b feature/docker-improvement
```

3. **Teste suas mudan√ßas extensivamente**
```bash
# Teste build limpo
docker-compose build --no-cache

# Teste execu√ß√£o
docker-compose up --build

# Teste diferentes cen√°rios
docker-compose --profile dev up fatigue-sensor-dev
```

4. **Commit suas mudan√ßas**
```bash
git commit -m 'feat: improve Docker configuration for better audio support'
```

5. **Push e abra Pull Request**
```bash
git push origin feature/docker-improvement
```

### Checklist para Contribui√ß√µes Docker

- [ ] Dockerfile funciona em diferentes arquiteturas (x86_64, ARM64)
- [ ] docker-compose.yml est√° bem documentado
- [ ] install.sh funciona em diferentes distribui√ß√µes Linux
- [ ] Testes passam no container
- [ ] Documenta√ß√£o atualizada
- [ ] Exemplo de uso funciona corretamente

## üìû Suporte e Ajuda

### Diagn√≥stico R√°pido

Execute o diagn√≥stico autom√°tico:

```bash
# Script de diagn√≥stico completo
./install.sh

# Ou verifica√ß√£o manual r√°pida
docker --version && docker-compose --version
ls /dev/video* /dev/snd/
echo $DISPLAY
xhost +local:docker 2>/dev/null || echo "X11 n√£o configurado"
```

### Onde Buscar Ajuda

1. **Logs do sistema**: `docker-compose logs -f`
2. **Documenta√ß√£o oficial**: Este arquivo e README.md
3. **Issues no GitHub**: Para problemas espec√≠ficos
4. **Comunidade Docker**: Para problemas gerais de containeriza√ß√£o

### Informa√ß√µes √öteis para Reportar Problemas

Ao reportar um problema, inclua:

```bash
# Informa√ß√µes do sistema
uname -a
docker --version
docker-compose --version

# Status dos dispositivos
ls -la /dev/video* 2>/dev/null || echo "Nenhuma c√¢mera encontrada"
ls -la /dev/snd/ 2>/dev/null || echo "Nenhum dispositivo de √°udio"

# Vari√°veis de ambiente relevantes
echo "DISPLAY: $DISPLAY"
echo "XDG_RUNTIME_DIR: $XDG_RUNTIME_DIR"

# Logs do container
docker-compose logs --tail=50
```

---

### üéâ Desenvolvido com ‚ù§Ô∏è para facilitar o desenvolvimento e implanta√ß√£o

**Vers√£o da documenta√ß√£o**: 2.0  
**√öltima atualiza√ß√£o**: 2024  
**Compatibilidade**: Docker 20.10+, Docker Compose 2.0+

> üí° **Dica**: Execute `./install.sh` para configura√ß√£o autom√°tica e r√°pida!
